<div class="aquarium-new-container">
  <!-- Success Modal -->
  <div class="success-modal" *ngIf="showSuccess">
    <div class="success-content">
      <div class="success-icon">
        <svg width="120" height="120" viewBox="0 0 120 120" fill="none">
          <circle cx="60" cy="60" r="50" stroke="#00c851" stroke-width="4" fill="none" opacity="0.2"/>
          <path d="M35 60l15 15 30-30" stroke="#00c851" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <h2>üéâ Aquarium Created Successfully!</h2>
      <p>Your new aquarium is ready to go. Redirecting you back...</p>
    </div>
  </div>

  <!-- Header -->
  <div class="form-header">
    <button class="btn-back" (click)="goBack()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.42-1.41L7.83 13H20v-2z"/>
      </svg>
      Back to Aquariums
    </button>
    
    <div class="header-content">
      <h1>Create New Aquarium</h1>
      <p>Set up your new aquatic environment in just a few simple steps</p>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="progressPercentage"></div>
      </div>
      <div class="step-indicators">
        <div 
          *ngFor="let step of [1, 2, 3, 4]; index as i" 
          class="step-indicator"
          [class.active]="currentStep === step"
          [class.completed]="currentStep > step"
        >
          <span class="step-number">{{ step }}</span>
          <span class="step-label">
            {{ getStepLabel(step) }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Form Container -->
  <div class="form-container">
    <form [formGroup]="aquariumForm" (ngSubmit)="onSubmit()">
      
      <!-- Step 1: Aquarium Name -->
      <div class="form-step" *ngIf="currentStep === 1">
        <div class="step-content">
          <div class="step-icon">üê†</div>
          <h2>What would you like to name your aquarium?</h2>
          <p>Choose a memorable name that reflects its character</p>
          
          <div class="input-group">
            <label for="aquarium-name">Aquarium Name</label>
            <input
              id="aquarium-name"
              type="text"
              formControlName="name"
              placeholder="e.g., Community Tank, Reef Paradise, Goldfish Haven..."
              [class.invalid]="aquariumForm.get('name')?.invalid && aquariumForm.get('name')?.touched"
            >
            <div class="input-feedback" *ngIf="aquariumForm.get('name')?.invalid && aquariumForm.get('name')?.touched">
              <span *ngIf="aquariumForm.get('name')?.errors?.['required']">Please enter a name for your aquarium</span>
              <span *ngIf="aquariumForm.get('name')?.errors?.['minlength']">Name must be at least 2 characters long</span>
              <span *ngIf="aquariumForm.get('name')?.errors?.['maxlength']">Name must be less than 50 characters</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: Aquarium Type -->
      <div class="form-step" *ngIf="currentStep === 2">
        <div class="step-content">
          <div class="step-icon">üåä</div>
          <h2>What type of aquarium are you setting up?</h2>
          <p>Each type has different requirements and inhabitants</p>
          
          <div class="type-grid">
            <div 
              *ngFor="let type of aquariumTypes"
              class="type-card"
              [class.selected]="aquariumForm.get('type')?.value === type.value"
              (click)="selectType(type.value)"
            >
              <div class="type-emoji">{{ type.emoji }}</div>
              <h3>{{ type.label }}</h3>
              <p>{{ type.description }}</p>
              <div class="type-indicator"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Capacity -->
      <div class="form-step" *ngIf="currentStep === 3">
        <div class="step-content">
          <div class="step-icon">üìè</div>
          <h2>How large is your aquarium?</h2>
          <p>This helps us set appropriate parameter ranges</p>
          
          <div class="capacity-section">
            <div class="capacity-grid">
              <button 
                *ngFor="let capacity of commonCapacities"
                type="button"
                class="capacity-option"
                [class.selected]="aquariumForm.get('capacity')?.value == capacity"
                (click)="selectCapacity(capacity)"
              >
                {{ capacity }}L
              </button>
            </div>
            
            <div class="custom-capacity">
              <label for="custom-capacity">Or enter a custom size:</label>
              <div class="capacity-input-group">
                <input
                  id="custom-capacity"
                  type="number"
                  formControlName="capacity"
                  placeholder="Enter liters"
                  min="1"
                  max="10000"
                >
                <span class="capacity-unit">Liters</span>
              </div>
            </div>
          </div>

          <!-- Optional Notes -->
          <div class="input-group notes-section">
            <label for="aquarium-notes">Additional Notes (Optional)</label>
            <textarea
              id="aquarium-notes"
              formControlName="notes"
              placeholder="Any special features, equipment, or plans for this aquarium..."
              rows="3"
            ></textarea>
          </div>
        </div>
      </div>

      <!-- Step 4: Inhabitants (Optional) -->
      <div class="form-step" *ngIf="currentStep === 4">
        <div class="step-content">
          <div class="step-icon">üê†</div>
          <h2>Add Inhabitants (Optional)</h2>
          <p>Add any fish, plants, or other creatures you plan to keep</p>
          
          <div class="inhabitants-section">
            <!-- Current Inhabitants List -->
            <div class="inhabitants-list" *ngIf="inhabitants.length > 0">
              <div 
                *ngFor="let inhabitant of inhabitants.controls; let i = index" 
                class="inhabitant-item"
                [formGroup]="inhabitant"
              >
                <div class="inhabitant-header">
                  <h4>Inhabitant {{ i + 1 }}</h4>
                  <button 
                    type="button" 
                    class="btn-remove" 
                    (click)="removeInhabitant(i)"
                    title="Remove inhabitant"
                  >
                    √ó
                  </button>
                </div>
                
                <div class="inhabitant-form">
                  <div class="form-row">
                    <div class="input-group">
                      <label [for]="'inhabitant-name-' + i">Name *</label>
                      <input
                        [id]="'inhabitant-name-' + i"
                        type="text"
                        formControlName="name"
                        placeholder="e.g., Neon Tetras, Java Fern"
                        [class.invalid]="inhabitant.get('name')?.invalid && inhabitant.get('name')?.touched"
                      >
                      <div class="input-feedback" *ngIf="inhabitant.get('name')?.invalid && inhabitant.get('name')?.touched">
                        <span *ngIf="inhabitant.get('name')?.errors?.['required']">Name is required</span>
                      </div>
                    </div>
                    
                    <div class="input-group">
                      <label [for]="'inhabitant-species-' + i">Species *</label>
                      <input
                        [id]="'inhabitant-species-' + i"
                        type="text"
                        formControlName="species"
                        placeholder="e.g., Paracheirodon innesi"
                        [class.invalid]="inhabitant.get('species')?.invalid && inhabitant.get('species')?.touched"
                      >
                      <div class="input-feedback" *ngIf="inhabitant.get('species')?.invalid && inhabitant.get('species')?.touched">
                        <span *ngIf="inhabitant.get('species')?.errors?.['required']">Species is required</span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="form-row">
                    <div class="input-group type-group">
                      <label>Type *</label>
                      <div class="type-options">
                        <button
                          *ngFor="let type of inhabitantTypes"
                          type="button"
                          class="type-option"
                          [class.selected]="inhabitant.get('type')?.value === type.value"
                          (click)="inhabitant.get('type')?.setValue(type.value)"
                        >
                          <span class="type-emoji">{{ type.emoji }}</span>
                          {{ type.label }}
                        </button>
                      </div>
                    </div>
                    
                    <div class="input-group quantity-group">
                      <label [for]="'inhabitant-quantity-' + i">Quantity *</label>
                      <input
                        [id]="'inhabitant-quantity-' + i"
                        type="number"
                        formControlName="quantity"
                        min="1"
                        max="1000"
                        [class.invalid]="inhabitant.get('quantity')?.invalid && inhabitant.get('quantity')?.touched"
                      >
                      <div class="input-feedback" *ngIf="inhabitant.get('quantity')?.invalid && inhabitant.get('quantity')?.touched">
                        <span *ngIf="inhabitant.get('quantity')?.errors?.['required']">Quantity is required</span>
                        <span *ngIf="inhabitant.get('quantity')?.errors?.['min']">Minimum quantity is 1</span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="input-group">
                    <label [for]="'inhabitant-notes-' + i">Notes (Optional)</label>
                    <textarea
                      [id]="'inhabitant-notes-' + i"
                      formControlName="notes"
                      placeholder="Special care notes, behavior, etc..."
                      rows="2"
                    ></textarea>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Add Inhabitant Section -->
            <div class="add-inhabitant-section">
              <!-- Mode Selection -->
              <div class="mode-selection">
                <h4>{{ inhabitants.length === 0 ? 'Add Your First Inhabitant' : 'Add Another Inhabitant' }}</h4>
                <div class="mode-buttons">
                  <button 
                    type="button"
                    class="mode-btn"
                    [class.active]="addMode === 'library'"
                    (click)="setAddMode('library')"
                  >
                    üìö From Library
                  </button>
                  <button 
                    type="button"
                    class="mode-btn"
                    [class.active]="addMode === 'custom'"
                    (click)="setAddMode('custom')"
                  >
                    ‚úèÔ∏è Custom Entry
                  </button>
                </div>
              </div>

              <!-- Library Mode -->
              <div class="library-mode" *ngIf="addMode === 'library'">
                <!-- Filters -->
                <div class="library-filters">
                  <div class="filter-row">
                    <div class="search-box">
                      <input
                        type="text"
                        placeholder="Search by name, species, or notes..."
                        [value]="libraryFilter"
                        (input)="onSearchChange($event)"
                        class="search-input"
                      >
                    </div>
                    <select 
                      [value]="selectedLibraryType"
                      (change)="onTypeFilterChange($event)"
                      class="type-filter"
                    >
                      <option value="">All Types</option>
                      <option *ngFor="let type of inhabitantTypes" [value]="type.value">
                        {{ type.emoji }} {{ type.label }}
                      </option>
                    </select>
                    <button 
                      type="button" 
                      class="clear-filters-btn"
                      (click)="clearLibraryFilters()"
                      *ngIf="libraryFilter || selectedLibraryType"
                    >
                      Clear
                    </button>
                  </div>
                </div>

                <!-- Library Grid -->
                <div class="library-grid" *ngIf="filteredLibrary.length > 0">
                  <div 
                    *ngFor="let item of filteredLibrary"
                    class="library-item"
                    (click)="addInhabitantFromLibrary(item)"
                  >
                    <div class="item-header">
                      <span class="item-emoji">{{ getInhabitantEmoji(item.type) }}</span>
                      <span class="item-name">{{ item.name }}</span>
                    </div>
                    <div class="item-species">{{ item.species }}</div>
                    <div class="item-notes">{{ item.notes }}</div>
                    <div class="add-overlay">
                      <span class="add-text">Click to Add</span>
                    </div>
                  </div>
                </div>

                <!-- No Results -->
                <div class="no-results" *ngIf="filteredLibrary.length === 0">
                  <p>No inhabitants found matching your criteria.</p>
                  <button 
                    type="button" 
                    class="btn btn-secondary"
                    (click)="clearLibraryFilters()"
                  >
                    Clear Filters
                  </button>
                </div>
              </div>

              <!-- Custom Mode -->
              <div class="custom-mode" *ngIf="addMode === 'custom'">
                <button 
                  type="button" 
                  class="btn btn-secondary btn-add-custom"
                  (click)="addInhabitant()"
                >
                  <span class="add-icon">+</span>
                  Add Custom Inhabitant
                </button>
              </div>
            </div>
            
            <!-- Skip Message -->
            <div class="skip-message" *ngIf="inhabitants.length === 0">
              <p>üí° Don't worry - you can always add inhabitants later from the aquarium details page.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="form-navigation">
        <button 
          type="button" 
          class="btn btn-secondary" 
          *ngIf="currentStep > 1"
          (click)="previousStep()"
        >
          Previous
        </button>
        
        <div class="nav-spacer"></div>
        
        <button 
          type="button" 
          class="btn btn-primary" 
          *ngIf="currentStep < totalSteps"
          [disabled]="!canProceed()"
          (click)="nextStep()"
        >
          Next Step
        </button>
        
        <button 
          type="submit" 
          class="btn btn-primary btn-create" 
          *ngIf="currentStep === totalSteps"
          [disabled]="!aquariumForm.valid || isSubmitting"
        >
          <span *ngIf="!isSubmitting">üéØ Create Aquarium</span>
          <span *ngIf="isSubmitting" class="loading-state">
            <svg class="spinner" width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" opacity="0.3"/>
              <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="2" fill="none"/>
            </svg>
            Creating...
          </span>
        </button>
      </div>
    </form>
  </div>
</div>